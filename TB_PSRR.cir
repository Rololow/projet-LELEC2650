* TSMC 65nm Cascode Miller OTA Simulation - PSRR (Power Supply Rejection Ratio)
* December 2024
*-----------------------------------------------

************************************
*	Library & Technology settings
************************************

* Library containing the transistor model from the foundry
.LIB key=K1 '/dir/TECHNOLOGY/cds2024/TSMC-N65/CMOS/LP/pdk/models/eldo/toplevel.eldo' tt_lib

************************************
*	Include circuit definition
************************************

.include ./CascodeMillerOTA.cir

*******************************
*	Supply
*******************************

*** Supply voltage with AC for PSRR measurement
VVDD VDD GND DC vdd_val AC 1

*******************************
*	Stimuli - PSRR+ (positive supply)
*******************************

*** PSRR Measurement Setup
* Short inputs to ground (or DC bias)
* Apply AC signal on VDD
* Measure output response

* Input bias (no AC, both inputs at same DC)
VVINp INp GND DC VIN
VVINm INm GND DC VIN

**********************************
*	Simulations
**********************************

.OP

*** AC analysis for PSRR
* Use the global AC parameters from the device include so all TBs share the same grid
.AC dec ac_dec fmin fmax

**********************************
*	Measurements
**********************************

*** Plot signals
.plot AC VDB(OUT) VP(OUT)

*** Supply to output gain (for PSRR calculation)
* PSRR = Adm / (Vout/Vdd) = Adm_dB - (Vout/Vdd)_dB

* Output response to supply variation
.extract AC label=Avdd_dB_1Hz 'yval(VDB(OUT),1)'
.extract AC label=Avdd_dB_1kHz 'yval(VDB(OUT),1e3)'
.extract AC label=Avdd_dB_1MHz 'yval(VDB(OUT),1e6)'
.extract AC label=Avdd_dB_max 'max(VDB(OUT))'

*** PSRR = Adm / Avdd = Adm_dB - Avdd_dB
* Compute PSRR directly from the VDD->OUT transfer (dB): PSRR_dB = -VDB(OUT)
.extract AC label=PSRR_1Hz '-yval(VDB(OUT),1)'
.extract AC label=PSRR_1kHz '-yval(VDB(OUT),1e3)'
.extract AC label=PSRR_1MHz '-yval(VDB(OUT),1e6)'
.extract AC label=PSRR_dB_max 'max(-yval(VDB(OUT),1), max(-yval(VDB(OUT),1e3), -yval(VDB(OUT),1e6)))'

*** DC operating point
.extract DC label=VOUT_DC V(OUT)
.extract DC label=Power '-V(VDD)*I(VVDD)'

* ------------------------------------------------------------------
* Example export (ASCII) for VDD->OUT transfer (frequency, VDB(OUT))
* Write `vdd_out.txt` which `plot_results.py` can read for PSRR.
*
.printfile AC VDB(OUT) file=vdd_out.txt format=data
*
* Also allow case-insensitive alternative name sometimes produced by tools
.printfile AC VDB(OUT) file=VDD_OUT.txt format=data
*
* Note: ensure `VVDD VDD GND DC vdd_val AC 1` is present (it is), then run this TB.
* ------------------------------------------------------------------

.end
